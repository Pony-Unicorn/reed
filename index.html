<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="color-scheme" content="light dark" />
    <title>Reed</title>
    <meta
      name="description"
      content="Secure peer-to-peer transfer tool for end-to-end encrypted transmission of passwords, private keys, mnemonics, and files"
    />

    <!-- SEO & Meta -->
    <meta
      name="keywords"
      content="end-to-end encryption,secure transfer,p2p,password sharing,private key transfer"
    />
    <meta name="author" content="Reed Contributors" />

    <!-- Security & Privacy -->
    <meta name="referrer" content="no-referrer" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Reed â€” End-to-End Encrypted Transfer" />
    <meta
      property="og:description"
      content="By encrypting one end to generate a QR code and scanning the code to decrypt it on the other end, point-to-point secure transmission without the need for a network or a transfer server is achieved."
    />
    <meta property="og:url" content="https://reed.testbug.cc" />
    <meta
      property="og:image"
      content="https://cdn.jsdelivr.net/gh/Pony-Unicorn/reed/logo.png"
    />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Reed â€” End-to-End Encrypted Transfer" />
    <meta
      name="twitter:description"
      content="By encrypting one end to generate a QR code and scanning the code to decrypt it on the other end, point-to-point secure transmission without the need for a network or a transfer server is achieved."
    />
    <meta
      name="twitter:image"
      content="https://cdn.jsdelivr.net/gh/Pony-Unicorn/reed/logo.png"
    />

    <!-- Performance -->
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/x-icon"
      href="https://cdn.jsdelivr.net/gh/Pony-Unicorn/reed/favicon.ico"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="https://cdn.jsdelivr.net/gh/Pony-Unicorn/reed/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="https://cdn.jsdelivr.net/gh/Pony-Unicorn/reed/favicon-16x16.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="https://cdn.jsdelivr.net/gh/Pony-Unicorn/reed/apple-touch-icon.png"
    />

    <style>
      /* ========================================
         CSS Variables - Color System
         Based on logo.png colors
         ======================================== */
      :root {
        /* Color Scheme Support */
        color-scheme: light dark;

        /* Primary - Blue (from water waves) */
        --primary-50: #eff6ff;
        --primary-100: #dbeafe;
        --primary-200: #bfdbfe;
        --primary-300: #93c5fd;
        --primary-400: #60a5fa;
        --primary-500: #3b82f6;
        --primary-600: #2563eb;
        --primary-700: #1d4ed8;
        --primary-800: #1e40af;
        --primary-900: #1e3a8a;

        /* Accent - Green (from reed leaves) */
        --accent-50: #ecfdf5;
        --accent-100: #d1fae5;
        --accent-200: #a7f3d0;
        --accent-300: #6ee7b7;
        --accent-400: #34d399;
        --accent-500: #10b981;
        --accent-600: #059669;
        --accent-700: #047857;
        --accent-800: #065f46;
        --accent-900: #064e3b;

        /* Neutral - Brown/Gray (from reed stems) */
        --neutral-50: #fafaf9;
        --neutral-100: #f5f5f4;
        --neutral-200: #e7e5e4;
        --neutral-300: #d6d3d1;
        --neutral-400: #a8a29e;
        --neutral-500: #78716c;
        --neutral-600: #57534e;
        --neutral-700: #44403c;
        --neutral-800: #292524;
        --neutral-900: #1c1917;

        /* Semantic Colors - Light Theme (slightly darker) */
        --background: var(--neutral-100);
        --foreground: var(--neutral-900);
        --surface: var(--neutral-50);
        --border: var(--neutral-300);
        --text-primary: var(--neutral-900);
        --text-secondary: var(--neutral-700);
        --text-muted: var(--neutral-500);

        /* Functional Colors */
        --success: var(--accent-500);
        --warning: #f59e0b;
        --error: #ef4444;
        --info: var(--primary-500);

        /* Spacing */
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        --spacing-2xl: 3rem;

        /* Border Radius */
        --radius-sm: 0.25rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --radius-full: 9999px;

        /* Shadows */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }

      /* ========================================
         Dark Theme (Auto-adaptive & Manual)
         ======================================== */
      @media (prefers-color-scheme: dark) {
        :root:not([data-theme="light"]) {
          /* Semantic Colors - Dark Theme */
          --background: var(--neutral-900);
          --foreground: var(--neutral-100);
          --surface: var(--neutral-800);
          --border: var(--neutral-700);
          --text-primary: var(--neutral-50);
          --text-secondary: var(--neutral-300);
          --text-muted: var(--neutral-500);

          /* Adjust shadows for dark theme */
          --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
          --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
        }
      }

      /* Manual dark theme toggle */
      [data-theme="dark"] {
        /* Semantic Colors - Dark Theme */
        --background: var(--neutral-900);
        --foreground: var(--neutral-100);
        --surface: var(--neutral-800);
        --border: var(--neutral-700);
        --text-primary: var(--neutral-50);
        --text-secondary: var(--neutral-300);
        --text-muted: var(--neutral-500);

        /* Adjust shadows for dark theme */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
      }

      /* ========================================
         Reset & Base Styles
         ======================================== */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: var(--foreground);
        background-color: var(--background);
        min-height: 100vh;
      }

      /* ========================================
         Layout Utilities
         ======================================== */
      .flex {
        display: flex;
      }

      .flex-col {
        flex-direction: column;
      }

      .flex-wrap {
        flex-wrap: wrap;
      }

      .items-center {
        align-items: center;
      }

      .justify-between {
        justify-content: space-between;
      }

      .gap-sm {
        gap: var(--spacing-sm);
      }
      .gap-md {
        gap: var(--spacing-md);
      }
      .gap-xl {
        gap: var(--spacing-xl);
      }

      .grid {
        display: grid;
      }

      .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }

      /* ========================================
         Spacing Utilities
         ======================================== */
      .mt-xs {
        margin-top: var(--spacing-xs);
      }
      .mt-md {
        margin-top: var(--spacing-md);
      }
      .mb-lg {
        margin-bottom: var(--spacing-lg);
      }

      /* ========================================
         Typography
         ======================================== */
      .text-sm {
        font-size: 0.875rem;
      }
      .text-2xl {
        font-size: 1.5rem;
      }

      .font-semibold {
        font-weight: 600;
      }
      .font-bold {
        font-weight: 700;
      }

      .text-muted {
        color: var(--text-muted);
      }

      .text-secondary {
        color: var(--text-secondary);
      }

      /* ========================================
         Display & Visibility Utilities
         ======================================== */
      .hidden {
        display: none !important;
      }

      /* ========================================
         Margin Utilities
         ======================================== */
      .m-0 {
        margin: 0;
      }

      /* ========================================
         Button Component with Variants
         ======================================== */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-lg);
        font-size: 1rem;
        font-weight: 500;
        line-height: 1.5;
        border-radius: var(--radius-md);
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        white-space: nowrap;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-sm {
        padding: var(--spacing-xs) var(--spacing-md);
        font-size: 0.875rem;
      }

      /* Primary Button Variants */
      .btn-primary-solid {
        background-color: var(--primary-600);
        color: white;
      }
      .btn-primary-solid:hover:not(:disabled) {
        background-color: var(--primary-700);
      }

      .btn-primary-soft {
        background-color: var(--primary-100);
        color: var(--primary-700);
      }
      .btn-primary-soft:hover:not(:disabled) {
        background-color: var(--primary-200);
      }

      /* Accent Button Variants */
      .btn-accent-solid {
        background-color: var(--accent-600);
        color: white;
      }
      .btn-accent-solid:hover:not(:disabled) {
        background-color: var(--accent-700);
      }

      /* Neutral Button Variants */
      .btn-neutral-outline {
        background-color: transparent;
        color: var(--neutral-600);
        border-color: var(--neutral-600);
      }
      .btn-neutral-outline:hover:not(:disabled) {
        background-color: var(--neutral-50);
      }

      /* ========================================
         Card Component
         ======================================== */
      .card {
        background-color: var(--surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
        padding: var(--spacing-sm);
      }

      /* ========================================
         Input Component
         ======================================== */
      .input {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 1rem;
        line-height: 1.5;
        color: var(--foreground);
        background-color: var(--surface);
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        transition: all 0.2s ease;
      }

      .input:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px var(--primary-100);
      }

      .textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
      }

      /* ========================================
         Container & Layout
         ======================================== */
      .container {
        width: 100%;
        max-width: 1200px;
        margin: 16px auto;
        padding: 0 var(--spacing-md);
      }

      /* ========================================
         Header Styles
         ======================================== */
      .header {
        padding: var(--spacing-sm) 0;
        border-bottom: 1px solid var(--border);
        background-color: var(--surface);
      }
      .header-inner {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 var(--spacing-md);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .theme-toggle-btn {
        background: transparent;
        border: 2px solid var(--border);
        border-radius: var(--radius-full);
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.25rem;
        transition: all 0.3s ease;
        flex-shrink: 0;
      }

      .theme-toggle-btn:hover {
        background-color: var(--surface);
        border-color: var(--primary-500);
        transform: scale(1.05);
      }

      .theme-toggle-btn:active {
        transform: scale(0.95);
      }

      .logo {
        width: 48px;
        height: 56px;
      }

      /* ========================================
         Component Specific Styles
         ======================================== */
      .qr-display {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 306px;
        background-color: var(--surface);
        border-radius: var(--radius-md);
        border: 2px dashed var(--border);
        /* Security: Prevent text selection and copying */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      #qrPlaceholder {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      #qrcode {
        width: 300px;
        height: 300px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #qrcode canvas,
      #qrcode img {
        max-width: 100%;
        height: auto;
        border-radius: var(--radius-md);
      }

      .scanner-container {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 306px;
        background-color: var(--surface);
        border-radius: var(--radius-md);
        border: 2px dashed var(--border);
      }

      #scanPlaceholder {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      #video {
        width: 300px;
        height: 300px;
        object-fit: contain;
        background-color: var(--neutral-900);
        display: none;
      }

      #video.active {
        display: block;
      }

      #canvas {
        width: 300px;
        height: 300px;
        object-fit: contain;
        background-color: var(--neutral-900);
        display: none;
      }

      #canvas.active {
        display: block;
      }

      .scanner-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;
        height: 300px;
        border: 3px solid var(--primary-500);
        border-radius: var(--radius-lg);
        pointer-events: none;
      }

      .scanner-corners {
        position: absolute;
        inset: -3px;
      }

      .scanner-corner {
        position: absolute;
        width: 30px;
        height: 30px;
        border: 4px solid var(--primary-500);
      }

      .scanner-corner.top-left {
        top: 0;
        left: 0;
        border-right: none;
        border-bottom: none;
      }

      .scanner-corner.top-right {
        top: 0;
        right: 0;
        border-left: none;
        border-bottom: none;
      }

      .scanner-corner.bottom-left {
        bottom: 0;
        left: 0;
        border-right: none;
        border-top: none;
      }

      .scanner-corner.bottom-right {
        bottom: 0;
        right: 0;
        border-left: none;
        border-top: none;
      }

      .canvas-privacy-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;
        height: 300px;
        background: repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 1) 0px,
          rgba(0, 0, 0, 1) 12px,
          transparent 12px,
          transparent 24px
        );
        pointer-events: none;
        z-index: 10;
        border-radius: var(--radius-md);
      }

      .result-box {
        min-height: 100px;
        padding: var(--spacing-md);
        background-color: var(--accent-50);
        border: 2px solid var(--accent-200);
        border-radius: var(--radius-md);
        word-break: break-all;
      }

      /* ========================================
         Visibility Toggle Component
         ======================================== */
      .input-wrapper,
      .result-wrapper {
        position: relative;
      }

      .toggle-visibility-btn {
        position: absolute;
        top: var(--spacing-sm);
        right: var(--spacing-sm);
        background: transparent;
        border: none;
        cursor: pointer;
        padding: var(--spacing-xs);
        font-size: 1.25rem;
        line-height: 1;
        color: var(--neutral-500);
        transition: color 0.2s ease;
        z-index: 10;
      }

      .toggle-visibility-btn:hover {
        color: var(--primary-600);
      }

      .toggle-visibility-btn:focus {
        outline: 2px solid var(--primary-500);
        outline-offset: 2px;
        border-radius: var(--radius-sm);
      }

      /* Blur effect for hidden content */
      .content-hidden {
        filter: blur(8px);
        user-select: none;
        pointer-events: none;
        transition: filter 0.2s ease;
      }

      .result-wrapper .toggle-visibility-btn {
        top: var(--spacing-md);
        right: var(--spacing-md);
      }

      /* ========================================
         Encryption Component
         ======================================== */
      .otp-display {
        color: var(--accent-700);
        font-family: monospace;
        font-size: 0.875rem;
      }

      .otp-toggle-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 4px;
        font-size: 1.125rem;
        line-height: 1;
        color: var(--neutral-500);
        transition: color 0.2s ease;
      }

      .otp-toggle-btn:hover {
        color: var(--primary-600);
      }

      .encrypt-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .encrypt-label {
        cursor: pointer;
      }

      .decrypt-header {
        color: var(--primary-700);
      }

      .otp-inputs {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: nowrap;
        justify-content: center;
      }

      .otp-digit-input {
        width: 32px;
        height: 44px;
        text-align: center;
        font-size: 1.125rem;
        font-weight: 600;
        font-family: monospace;
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        background-color: var(--surface);
        color: var(--text-primary);
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .otp-digit-input:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px var(--primary-100);
      }

      .otp-separator {
        color: var(--text-secondary);
        font-weight: bold;
        font-size: 1.25rem;
        user-select: none;
        flex-shrink: 0;
      }

      /* ========================================
         FAQ Component
         ======================================== */
      .faq-section {
        background-color: var(--surface);
        border-top: 1px solid var(--border);
        padding: var(--spacing-2xl) 0;
        margin-top: var(--spacing-2xl);
      }

      .faq-item {
        margin-bottom: var(--spacing-xl);
      }

      .faq-question {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--foreground);
        margin-bottom: var(--spacing-sm);
      }

      .faq-answer {
        color: var(--text-secondary);
        line-height: 1.8;
      }

      .faq-answer ul {
        margin: var(--spacing-sm) 0;
        padding-left: var(--spacing-lg);
      }

      .faq-answer li {
        margin-bottom: var(--spacing-xs);
      }

      .faq-contact {
        display: flex;
        gap: var(--spacing-lg);
        flex-wrap: wrap;
        margin-top: var(--spacing-md);
      }

      .faq-contact a {
        color: var(--primary-600);
        text-decoration: none;
        transition: color 0.2s ease;
      }

      .faq-contact a:hover {
        color: var(--primary-700);
        text-decoration: underline;
      }

      /* ========================================
         Toast Component
         ======================================== */
      .toast {
        position: fixed;
        top: var(--spacing-lg);
        left: 50%;
        transform: translateX(-50%);
        background: var(--surface);
        color: var(--text-muted);
        padding: var(--spacing-xs) var(--spacing-lg);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border);
        z-index: 9999;
        max-width: 90%;
        width: auto;
        min-width: 200px;
        text-align: center;
        font-size: 0.9375rem;
        line-height: 1.5;
        animation: toastSlideDown 0.3s ease;
      }

      @keyframes toastSlideDown {
        from {
          transform: translateX(-50%) translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }
      }

      .toast.toast-hide {
        animation: toastSlideUp 0.3s ease forwards;
      }

      @keyframes toastSlideUp {
        from {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }
        to {
          transform: translateX(-50%) translateY(-20px);
          opacity: 0;
        }
      }

      /* Toast types */
      .toast-success {
        border-left: 4px solid var(--success);
        background: var(--accent-50);
      }

      .toast-error {
        border-left: 4px solid var(--error);
        background: #fef2f2;
      }

      .toast-warning {
        border-left: 4px solid var(--warning);
        background: #fffbeb;
      }

      .toast-info {
        border-left: 4px solid var(--info);
        background: var(--primary-50);
      }

      /* ========================================
         Responsive Design
         ======================================== */
      @media (min-width: 768px) {
        .grid-cols-md-2 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .toast {
          max-width: 400px;
        }
      }

      /* Flip video only on desktop devices (not mobile) */
      @media (hover: hover) and (pointer: fine) {
        #video {
          transform: scaleX(-1);
        }
      }
    </style>

    <script
      src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"
      defer
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"
      defer
    ></script>
  </head>

  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-inner">
        <div class="flex items-center gap-md">
          <img
            src="https://cdn.jsdelivr.net/gh/Pony-Unicorn/reed/logo.png"
            alt="Reed Logo"
            class="logo"
          />
          <div>
            <h1 class="text-2xl font-bold">Reed</h1>
            <p class="text-sm text-secondary">
              air-gapped conduit for sensitive data.
            </p>
          </div>
        </div>
        <button
          id="themeToggle"
          class="theme-toggle-btn"
          onclick="toggleTheme()"
          title="Toggle theme"
          aria-label="Toggle color theme"
        >
          <span id="themeIcon">ğŸŒ™</span>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container">
      <div class="grid grid-cols-1 grid-cols-md-2 gap-xl">
        <!-- Section A: Generate QR Code -->
        <section class="card">
          <h2 class="text-2xl font-semibold mb-lg">ğŸ“¤ Generate QR Code</h2>
          <div class="flex flex-col gap-md">
            <div class="qr-display" id="qrDisplay">
              <p class="text-sm text-muted" id="qrPlaceholder">
                Waiting generation...
              </p>
              <div id="qrcode"></div>
            </div>
            <button
              id="toggleQrBtn"
              class="btn btn-secondary-outline btn-sm hidden"
              onclick="toggleQrVisibility()"
            >
              <span id="toggleQrBtnText">âœ“ éšè—</span>
            </button>

            <div class="input-wrapper">
              <button
                class="toggle-visibility-btn"
                id="toggleInputBtn"
                onclick="toggleInputVisibility()"
                title="Show/Hide content"
                aria-label="Toggle input visibility"
              >
                ğŸ‘ï¸
              </button>
              <textarea
                id="textInput"
                class="input textarea"
                placeholder="text, password, privateKey, mnemonic, etc."
                autocomplete="off"
                spellcheck="false"
                data-gramm="false"
                data-gramm_editor="false"
                data-enable-grammarly="false"
              ></textarea>
              <div class="text-sm text-muted mt-xs">
                <span id="charCount">0</span> / 200 characters
              </div>
            </div>

            <!-- Encryption Options -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-sm">
                <span id="otpCode" class="text-sm font-semibold otp-display"
                  >--</span
                >
                <button
                  id="toggleOtpBtn"
                  class="otp-toggle-btn hidden"
                  onclick="toggleOtpVisibility()"
                  title="Show OTP"
                >
                  ğŸ‘ï¸
                </button>
              </div>
              <label class="flex items-center gap-sm encrypt-label">
                <input
                  type="checkbox"
                  id="encryptCheckbox"
                  class="encrypt-checkbox"
                  onchange="handleEncryptionToggle()"
                />
                <span class="text-sm">ğŸ” Encrypt</span>
              </label>
            </div>

            <div class="flex gap-sm flex-wrap justify-between">
              <button
                class="btn btn-neutral-outline btn-sm"
                onclick="reloadPage()"
              >
                ğŸ—‘ï¸ Reset
              </button>
              <button
                id="generateBtn"
                class="btn btn-primary-solid btn-sm"
                onclick="generateQRCode()"
              >
                ğŸ¯ Gen QR
              </button>
            </div>
          </div>
        </section>

        <!-- Section B: Scan QR Code -->
        <section class="card">
          <h2 class="text-2xl font-semibold mb-lg">ğŸ“¥ Scan QR Code</h2>

          <div class="flex flex-col gap-md">
            <div>
              <div class="scanner-container">
                <p class="text-sm text-muted" id="scanPlaceholder">
                  Waiting scanning...
                </p>
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <div
                  class="canvas-privacy-overlay hidden"
                  id="canvasPrivacyOverlay"
                ></div>
                <div class="scanner-overlay hidden" id="scannerOverlay">
                  <div class="scanner-corners">
                    <div class="scanner-corner top-left"></div>
                    <div class="scanner-corner top-right"></div>
                    <div class="scanner-corner bottom-left"></div>
                    <div class="scanner-corner bottom-right"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Decryption Options -->
            <div id="decryptionPanel" class="hidden flex flex-col gap-sm">
              <div class="otp-inputs">
                <input
                  type="text"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  id="otp0"
                  class="otp-digit-input"
                  autocomplete="off"
                />
                <input
                  type="text"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  id="otp1"
                  class="otp-digit-input"
                  autocomplete="off"
                />
                <input
                  type="text"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  id="otp2"
                  class="otp-digit-input"
                  autocomplete="off"
                />
                <input
                  type="text"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  id="otp3"
                  class="otp-digit-input"
                  autocomplete="off"
                />
                <span class="otp-separator">-</span>
                <input
                  type="text"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  id="otp4"
                  class="otp-digit-input"
                  autocomplete="off"
                />
                <input
                  type="text"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  id="otp5"
                  class="otp-digit-input"
                  autocomplete="off"
                />
                <input
                  type="text"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  id="otp6"
                  class="otp-digit-input"
                  autocomplete="off"
                />
                <input
                  type="text"
                  maxlength="1"
                  pattern="[0-9]"
                  inputmode="numeric"
                  id="otp7"
                  class="otp-digit-input"
                  autocomplete="off"
                />
              </div>
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold decrypt-header">
                  ğŸ”“ Enter 8-digit OTP
                </div>
                <button
                  class="btn btn-accent-solid btn-sm"
                  onclick="decryptResult()"
                >
                  ğŸ”“ Decrypt
                </button>
              </div>
            </div>

            <div class="result-wrapper">
              <button
                class="toggle-visibility-btn hidden"
                id="toggleResultBtn"
                onclick="toggleResultVisibility()"
                title="Show/Hide content"
                aria-label="Toggle result visibility"
              >
                ğŸ‘ï¸
              </button>
              <div class="result-box">
                <p class="text-sm text-muted" id="resultPlaceholder">
                  Waiting result...
                </p>
                <p id="scanResult" class="text-muted m-0 hidden"></p>
              </div>
            </div>

            <div class="flex gap-sm mt-md justify-between flex-wrap">
              <!-- Waiting State: Scan + Upload + Reset -->
              <button
                id="waitingResetBtn"
                class="btn btn-neutral-outline btn-sm"
                onclick="reloadPage()"
              >
                ğŸ—‘ï¸ Reset
              </button>
              <input
                type="file"
                id="imageInput"
                accept="image/*"
                style="display: none"
                onchange="handleImageUpload(event)"
              />
              <button
                id="uploadBtn"
                class="btn btn-primary-soft btn-sm"
                onclick="document.getElementById('imageInput').click()"
              >
                ğŸ–¼ï¸ Upload
              </button>
              <button
                id="scanBtn"
                class="btn btn-primary-solid btn-sm"
                onclick="startScanning()"
              >
                ğŸ“· Scan QR
              </button>
              <!-- Scanning State: Cancel + Confirm -->
              <button
                id="cancelBtn"
                class="btn btn-neutral-outline btn-sm hidden"
                onclick="stopScanning()"
              >
                âŒ Cancel
              </button>
              <button
                id="confirmBtn"
                class="btn btn-accent-solid btn-sm hidden"
                onclick="captureAndDecode()"
              >
                âœ… Confirm
              </button>

              <!-- Result State: Reset + Copy -->
              <button
                id="resultResetBtn"
                class="btn btn-neutral-outline btn-sm hidden"
                onclick="reloadPage()"
              >
                ğŸ—‘ï¸ Reset
              </button>
              <button
                id="resultCopyBtn"
                class="btn btn-primary-soft btn-sm hidden"
                onclick="copyResult()"
              >
                ğŸ“‹ Copy
              </button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- FAQ Section -->
    <section class="faq-section">
      <div class="container">
        <h2 class="text-2xl font-bold mb-lg">â“ FAQ - å¸¸è§é—®é¢˜</h2>

        <div class="faq-item">
          <h3 class="faq-question">Q: è¿™ä¸ªå·¥å…·å®‰å…¨å—ï¼Ÿ</h3>
          <div class="faq-answer">
            <p>
              Reed
              æ˜¯ä¸€ä¸ªå®Œå…¨ç¦»çº¿è¿è¡Œçš„å·¥å…·ï¼Œä¸ä¼šå°†æ‚¨çš„æ•°æ®å‘é€åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚æ‰€æœ‰æ“ä½œéƒ½åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å®Œæˆã€‚ä¸ºäº†è¿›ä¸€æ­¥æå‡å®‰å…¨æ€§ï¼Œå»ºè®®ï¼š
            </p>
            <ul>
              <li>ä½¿ç”¨æµè§ˆå™¨çš„æ— ç—•/éšç§æ¨¡å¼</li>
              <li>åœ¨ç¦»çº¿ç¯å¢ƒä¸­ä½¿ç”¨</li>
              <li>é‡‡ç”¨åˆ†æ®µä¼ è¾“çš„æ–¹å¼å¤„ç†æ•æ„Ÿä¿¡æ¯</li>
              <li>é¿å…ä½¿ç”¨å‰ªè´´æ¿å¤åˆ¶ç²˜è´´</li>
            </ul>
          </div>
        </div>

        <div class="faq-item">
          <h3 class="faq-question">Q: ä¸ºä»€ä¹ˆè¦é¿å…ä½¿ç”¨å‰ªè´´æ¿ï¼Ÿ</h3>
          <div class="faq-answer">
            <p>
              è®¸å¤šè½¯ä»¶å¯èƒ½ä¼šç›‘å¬æˆ–åŒæ­¥å‰ªè´´æ¿å†…å®¹ï¼ŒåŒ…æ‹¬è¾“å…¥æ³•ï¼ˆç‰¹åˆ«æ˜¯äº‘è¾“å…¥æ³•ï¼‰ã€ç¿»è¯‘å·¥å…·ã€å‰ªè´´æ¿å¢å¼ºå·¥å…·ç­‰ã€‚è™½ç„¶è¿™äº›è½¯ä»¶é€šå¸¸æ— æ³•è¯»å–å±å¹•æˆ–æ‘„åƒå¤´å†…å®¹ï¼Œä½†å¯ä»¥åœ¨æ‚¨å¤åˆ¶æ–‡æœ¬æ—¶è·å–å®Œæ•´å†…å®¹ã€‚å› æ­¤ï¼Œé¿å…è®©æ•æ„Ÿä¿¡æ¯è¿›å…¥å‰ªè´´æ¿æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é£é™©é™ä½æªæ–½ã€‚
            </p>
          </div>
        </div>

        <div class="faq-item">
          <h3 class="faq-question">Q: ä»€ä¹ˆæ˜¯åˆ†æ®µä¼ è¾“ï¼Ÿä¸ºä»€ä¹ˆæ¨èä½¿ç”¨ï¼Ÿ</h3>
          <div class="faq-answer">
            <p>
              åˆ†æ®µä¼ è¾“æ˜¯æŒ‡å°†é•¿çš„ç§é’¥æˆ–åŠ©è®°è¯æ‹†åˆ†æˆå¤šä¸ªè¾ƒçŸ­çš„ç‰‡æ®µï¼ˆå»ºè®® 3-5
              æ®µï¼‰ï¼Œåˆ†åˆ«ç”ŸæˆäºŒç»´ç å¹¶ä¼ è¾“ã€‚è¿™ç§æ–¹å¼çš„ä¼˜åŠ¿æ˜¯ï¼š
            </p>
            <ul>
              <li>é™ä½å•æ¬¡æ³„éœ²çš„é£é™©</li>
              <li>äºŒç»´ç æ›´æ¸…æ™°ï¼Œæ‰«ææˆåŠŸç‡æ›´é«˜</li>
              <li>å¯ä»¥çµæ´»é€‰æ‹©æŸäº›ç‰‡æ®µæ‰‹åŠ¨è¾“å…¥ï¼Œè€Œä¸é€šè¿‡äºŒç»´ç </li>
              <li>å³ä½¿éƒ¨åˆ†ç‰‡æ®µè¢«æˆªè·ï¼Œä¹Ÿæ— æ³•è·å¾—å®Œæ•´ä¿¡æ¯</li>
            </ul>
          </div>
        </div>

        <div class="faq-item">
          <h3 class="faq-question">Q: å¦‚ä½•ä½¿ç”¨æ— ç—•æ¨¡å¼ï¼Ÿ</h3>
          <div class="faq-answer">
            <p>åœ¨ä¸»æµæµè§ˆå™¨ä¸­æ‰“å¼€æ— ç—•/éšç§æ¨¡å¼çš„å¿«æ·é”®ï¼š</p>
            <ul>
              <li>
                <strong>Chrome / Edge</strong>: Ctrl + Shift + N (Windows/Linux)
                æˆ– Cmd + Shift + N (Mac)
              </li>
              <li>
                <strong>Firefox</strong>: Ctrl + Shift + P (Windows/Linux) æˆ–
                Cmd + Shift + P (Mac)
              </li>
              <li><strong>Safari</strong>: Cmd + Shift + N (Mac)</li>
            </ul>
            <p>
              æ— ç—•æ¨¡å¼å¯ä»¥é˜²æ­¢æµè§ˆå™¨æ‰©å±•è®¿é—®é¡µé¢å†…å®¹ï¼Œå¹¶åœ¨ä¼šè¯ç»“æŸåè‡ªåŠ¨æ¸…ç†æ‰€æœ‰æ•°æ®ã€‚
            </p>
          </div>
        </div>

        <div class="faq-item">
          <h3 class="faq-question">Q: ä¸ºä»€ä¹ˆé™åˆ¶ 200 å­—ç¬¦ï¼Ÿ</h3>
          <div class="faq-answer">
            <p>
              200
              å­—ç¬¦çš„é™åˆ¶æ˜¯ä¸ºäº†ç¡®ä¿äºŒç»´ç çš„æ‰«æè´¨é‡ã€‚è¾ƒé•¿çš„å†…å®¹ä¼šå¯¼è‡´äºŒç»´ç å˜å¾—å¯†é›†ï¼Œåœ¨
              256x256 åƒç´ çš„æ˜¾ç¤ºå°ºå¯¸ä¸‹éš¾ä»¥æ‰«æã€‚200
              å­—ç¬¦è¶³ä»¥æ»¡è¶³å¤§å¤šæ•°ä½¿ç”¨åœºæ™¯ï¼ŒåŒ…æ‹¬ï¼š
            </p>
            <ul>
              <li>å¯†ç ï¼šé€šå¸¸ 8-64 å­—ç¬¦</li>
              <li>æ¯”ç‰¹å¸ç§é’¥ï¼š52-64 å­—ç¬¦</li>
              <li>åŠ©è®°è¯ï¼ˆ12 è¯ï¼‰ï¼šçº¦ 150 å­—ç¬¦</li>
              <li>API Tokenï¼šé€šå¸¸ 32-256 å­—ç¬¦</li>
            </ul>
            <p>å¯¹äºæ›´é•¿çš„å†…å®¹ï¼ˆå¦‚ 24 è¯åŠ©è®°è¯ï¼‰ï¼Œå»ºè®®ä½¿ç”¨åˆ†æ®µä¼ è¾“çš„æ–¹å¼ã€‚</p>
          </div>
        </div>

        <div class="faq-item">
          <h3 class="faq-question">Q: é‡åˆ°é—®é¢˜æˆ–æœ‰å»ºè®®å¦‚ä½•åé¦ˆï¼Ÿ</h3>
          <div class="faq-answer">
            <p>æ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š</p>
            <div class="faq-contact">
              <a
                href="https://github.com/Pony-Unicorn/reed/issues"
                target="_blank"
                rel="noopener noreferrer"
                >ğŸ’¬ GitHub Issues</a
              >
              <a
                href="https://x.com/shunfengge"
                target="_blank"
                rel="noopener noreferrer"
                >ğŸ¦ Twitter/X @shunfengge</a
              >
            </div>
          </div>
        </div>

        <div class="faq-item">
          <h3 class="faq-question">âš ï¸ å…è´£å£°æ˜</h3>
          <div class="faq-answer">
            <p>
              è¯·ç¡®ä¿åœ¨å®‰å…¨ã€å¯ä¿¡çš„ç¯å¢ƒä¸­ä½¿ç”¨æœ¬å·¥å…·ã€‚ä»»ä½•ç§é’¥ä¸€æ—¦æ³„éœ²ï¼Œå‡å¯èƒ½å¯¼è‡´èµ„äº§æ°¸ä¹…æŸå¤±ã€‚æœ¬å·¥å…·ä»…æä¾›æŠ€æœ¯æ–¹æ¡ˆï¼Œä½¿ç”¨è€…éœ€è‡ªè¡Œæ‰¿æ‹…å®‰å…¨è´£ä»»ã€‚
            </p>
          </div>
        </div>
      </div>
    </section>

    <script>
      // ========================================
      // Utility
      // ========================================
      const $ = (id) => document.getElementById(id);

      // ========================================
      // Global State
      // ========================================
      let videoStream = null;
      let currentOtp = null;
      let encryptedContent = null; // Store encrypted scan result

      // ========================================
      // Encryption Toggle Handler
      // ========================================
      // ========================================
      // OTP Visibility Toggle
      // ========================================
      let otpAutoHideTimer = null;
      let otpActualValue = null;

      function toggleOtpVisibility() {
        const otpCode = $("otpCode");
        const toggleBtn = $("toggleOtpBtn");

        if (otpCode.textContent === "â€¢â€¢â€¢â€¢-â€¢â€¢â€¢â€¢") {
          // Show actual OTP
          otpCode.textContent = otpActualValue;
          toggleBtn.textContent = "ğŸ‘ï¸â€ğŸ—¨ï¸";
          toggleBtn.title = "Hide OTP";

          // Auto-hide after 5 seconds
          if (otpAutoHideTimer) clearTimeout(otpAutoHideTimer);
          otpAutoHideTimer = setTimeout(() => {
            hideOtp();
          }, 5000);
        } else {
          // Hide OTP
          hideOtp();
        }
      }

      function hideOtp() {
        const otpCode = $("otpCode");
        const toggleBtn = $("toggleOtpBtn");

        if (otpActualValue) {
          otpCode.textContent = "â€¢â€¢â€¢â€¢-â€¢â€¢â€¢â€¢";
          toggleBtn.textContent = "ğŸ‘ï¸";
          toggleBtn.title = "Show OTP";
        }

        if (otpAutoHideTimer) {
          clearTimeout(otpAutoHideTimer);
          otpAutoHideTimer = null;
        }
      }

      function handleEncryptionToggle() {
        const checkbox = $("encryptCheckbox");
        const otpCode = $("otpCode");
        const toggleBtn = $("toggleOtpBtn");

        if (checkbox.checked) {
          // Generate new OTP
          currentOtp = generateOtp();
          otpActualValue = otpToString(currentOtp);

          // Show hidden by default
          otpCode.textContent = "â€¢â€¢â€¢â€¢-â€¢â€¢â€¢â€¢";
          toggleBtn.classList.remove("hidden");
        } else {
          // Clear OTP and hide button
          currentOtp = null;
          otpActualValue = null;
          otpCode.textContent = "--";
          toggleBtn.classList.add("hidden");

          // Clear auto-hide timer
          if (otpAutoHideTimer) {
            clearTimeout(otpAutoHideTimer);
            otpAutoHideTimer = null;
          }
        }
      }

      // ========================================
      // QR Code Visibility Toggle
      // ========================================
      function toggleQrVisibility() {
        const qrcode = $("qrcode");
        const toggleBtn = $("toggleQrBtn");
        const toggleBtnText = $("toggleQrBtnText");

        if (qrcode.style.display === "none") {
          // Show QR code
          qrcode.style.display = "";
          toggleBtnText.textContent = "âœ“ éšè—";
        } else {
          // Hide QR code
          qrcode.style.display = "none";
          toggleBtnText.textContent = "ğŸ‘ï¸ æ˜¾ç¤º";
        }
      }

      // ========================================
      // Section A: Generate QR Code
      // ========================================
      async function generateQRCode() {
        const text = $("textInput").value.trim();
        const qrContainer = $("qrcode");
        const placeholder = $("qrPlaceholder");
        const encryptCheckbox = $("encryptCheckbox");

        if (!text) {
          showToast("Enter content", "warning");
          return;
        }

        // Character limit check (before encryption)
        const MAX_LENGTH = 200;
        if (text.length > MAX_LENGTH) {
          showToast(`Too long (${text.length}/${MAX_LENGTH})`, "error", 4000);
          return;
        }

        // Clear previous QR code
        qrContainer.innerHTML = "";

        try {
          // Determine the content to encode
          let contentToEncode = text;

          // Check if encryption is enabled
          if (encryptCheckbox.checked && currentOtp) {
            // Encrypt the text
            contentToEncode = await encryptOnce(text, currentOtp);
          }

          // Generate QR code with optimized settings for better scanning
          QRCode.toCanvas(
            contentToEncode,
            {
              width: 300,
              margin: 4, // Increased margin for better edge detection
              color: {
                dark: "#000000", // Pure black for maximum contrast
                light: "#ffffff", // Pure white
              },
              errorCorrectionLevel: "M", // Medium error correction (15%) - better balance for scanning
            },
            function (error, canvas) {
              if (error) {
                console.error(error);
                showToast("Generation failed", "error");
                return;
              }
              qrContainer.appendChild(canvas);
              placeholder.classList.add("hidden");

              // Show QR code and hide button
              qrContainer.style.display = "";
              $("toggleQrBtn").classList.remove("hidden");
              $("toggleQrBtnText").textContent = "âœ“ éšè—";

              // Hide input content for security
              hideInputContent();
            }
          );
        } catch (error) {
          console.error("Encryption error:", error);
          showToast("Encryption failed", "error");
        }
      }

      // ========================================
      // Image Upload and QR Code Recognition
      // ========================================
      function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith("image/")) {
          showToast("Please select an image file", "error");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const img = new Image();
          img.onload = function () {
            decodeQRFromImage(img);
          };
          img.onerror = function () {
            showToast("Failed to load image", "error");
          };
          img.src = e.target.result;
        };
        reader.onerror = function () {
          showToast("Failed to read file", "error");
        };
        reader.readAsDataURL(file);

        // Clear input for re-uploading same file
        event.target.value = "";
      }

      function decodeQRFromImage(img) {
        const canvas = $("canvas");
        const scanResult = $("scanResult");
        const resultPlaceholder = $("resultPlaceholder");
        const placeholder = $("scanPlaceholder");
        const video = $("video");
        const overlay = $("scannerOverlay");

        // Set canvas size to match image
        canvas.width = img.width;
        canvas.height = img.height;

        // Draw image to canvas with enhanced contrast
        const context = canvas.getContext("2d", { willReadFrequently: true });
        context.filter = "contrast(120%) brightness(105%)";
        context.drawImage(img, 0, 0, canvas.width, canvas.height);
        context.filter = "none";

        // Get image data
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

        // Decode QR code using jsQR
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "attemptBoth",
        });

        if (code) {
          // Success - show canvas and result
          placeholder.classList.add("hidden");
          video.classList.remove("active");
          canvas.classList.add("active");
          overlay.classList.add("hidden");

          // Show privacy overlay
          $("canvasPrivacyOverlay").classList.remove("hidden");

          // Check if content is encrypted
          const isEncrypted = code.data.startsWith("reed:v1.");

          if (isEncrypted) {
            encryptedContent = code.data;
            $("decryptionPanel").classList.remove("hidden");
            resultPlaceholder.textContent = "Enter OTP to decrypt...";
          } else {
            resultPlaceholder.classList.add("hidden");
            scanResult.classList.remove("hidden");
            scanResult.classList.add("content-hidden");
            scanResult.textContent = code.data;

            $("toggleResultBtn").classList.remove("hidden");
            $("toggleResultBtn").textContent = "ğŸ‘ï¸â€ğŸ—¨ï¸";
            $("toggleResultBtn").title = "Show content";
          }

          showResultButtons();
          showToast("QR code recognized!", "success", 2000);
        } else {
          showToast("No QR code found in image", "warning", 3000);
        }
      }

      async function startScanning() {
        const video = $("video");
        const placeholder = $("scanPlaceholder");
        const overlay = $("scannerOverlay");

        try {
          videoStream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { min: 640, ideal: 1280, max: 2560 }, // Balanced resolution for near and far distance
              height: { min: 640, ideal: 1280, max: 2560 },
            },
            audio: false,
          });

          video.srcObject = videoStream;

          // Hide placeholder, show video and overlay
          placeholder.classList.add("hidden");
          video.classList.add("active");
          overlay.classList.remove("hidden");

          // Show scanning buttons
          showScanningButtons();
        } catch (error) {
          console.error("Camera access error:", error);
          showToast("Camera access denied", "error", 4000);
        }
      }

      function captureAndDecode() {
        const video = $("video");
        const canvas = $("canvas");
        const scanResult = $("scanResult");
        const resultPlaceholder = $("resultPlaceholder");
        const overlay = $("scannerOverlay");

        // Set canvas size to match video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Draw video frame to canvas with enhanced contrast for better scanning
        // willReadFrequently: true - optimize for multiple getImageData() calls
        const context = canvas.getContext("2d", { willReadFrequently: true });

        // Apply image enhancement filters before drawing
        context.filter = "contrast(120%) brightness(105%)";
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        context.filter = "none"; // Reset filter

        // Get image data
        const imageData = context.getImageData(
          0,
          0,
          canvas.width,
          canvas.height
        );

        // Decode QR code using jsQR with optimized settings
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "attemptBoth", // Try both normal and inverted for better recognition in various lighting
        });

        if (code) {
          // Success - show canvas, stop camera and show result
          canvas.classList.add("active");
          video.classList.remove("active");
          overlay.classList.add("hidden");

          // Show privacy overlay to prevent shoulder surfing
          $("canvasPrivacyOverlay").classList.remove("hidden");

          // Stop video stream
          if (videoStream) {
            videoStream.getTracks().forEach((track) => track.stop());
            videoStream = null;
          }
          video.srcObject = null;

          // Check if content is encrypted (starts with "reed:v1.")
          const isEncrypted = code.data.startsWith("reed:v1.");

          if (isEncrypted) {
            // Store encrypted content and show decryption panel
            encryptedContent = code.data;
            $("decryptionPanel").classList.remove("hidden");
            resultPlaceholder.textContent = "Enter OTP to decrypt...";
          } else {
            // Show plain text result (blurred by default for privacy)
            resultPlaceholder.classList.add("hidden");
            scanResult.classList.remove("hidden");
            scanResult.classList.add("content-hidden");
            scanResult.textContent = code.data;

            // Show toggle visibility button for result
            $("toggleResultBtn").classList.remove("hidden");
            $("toggleResultBtn").textContent = "ğŸ‘ï¸â€ğŸ—¨ï¸";
            $("toggleResultBtn").title = "Show content";
          }

          showResultButtons();
        } else {
          // Failed - keep camera open, let user adjust and retry
          showToast("Not detected, adjust angle", "warning", 3000);
          // Camera remains open, user can click Confirm again to retry
        }
      }

      async function decryptResult() {
        const scanResult = $("scanResult");
        const resultPlaceholder = $("resultPlaceholder");
        const decryptionPanel = $("decryptionPanel");

        if (!encryptedContent) {
          showToast("No encrypted content", "error");
          return;
        }

        try {
          // Collect OTP from 8 input boxes
          const otpNums = [];
          for (let i = 0; i < 8; i++) {
            const input = $(`otp${i}`);
            const value = input.value.trim();

            if (!value) {
              showToast(`Enter all 8 digits`, "warning");
              input.focus();
              return;
            }

            const num = parseInt(value, 10);
            if (isNaN(num) || num < 0 || num > 9) {
              showToast("Invalid digit", "error");
              input.focus();
              return;
            }

            otpNums.push(num);
          }

          // Decrypt the content
          const decryptedText = await decryptOnce(encryptedContent, otpNums);

          // Show decrypted result (blurred by default for privacy)
          resultPlaceholder.classList.add("hidden");
          scanResult.classList.remove("hidden");
          scanResult.classList.add("content-hidden");
          scanResult.textContent = decryptedText;

          // Hide decryption panel
          decryptionPanel.classList.add("hidden");

          // Show toggle visibility button
          $("toggleResultBtn").classList.remove("hidden");
          $("toggleResultBtn").textContent = "ğŸ‘ï¸â€ğŸ—¨ï¸";
          $("toggleResultBtn").title = "Show content";

          // Clear all OTP inputs for security
          for (let i = 0; i < 8; i++) {
            $(`otp${i}`).value = "";
          }

          showToast("Decrypted!", "success", 2000);
        } catch (error) {
          console.error("Decryption error:", error);
          showToast("Decryption failed. Check OTP", "error", 4000);
        }
      }

      function resetScannerState() {
        const video = $("video");
        const placeholder = $("scanPlaceholder");
        const overlay = $("scannerOverlay");
        const canvas = $("canvas");

        // Stop video stream
        if (videoStream) {
          videoStream.getTracks().forEach((track) => track.stop());
          videoStream = null;
        }

        // Reset video and canvas
        video.srcObject = null;
        video.classList.remove("active");
        canvas.classList.remove("active");
        overlay.classList.add("hidden");

        // Hide privacy overlay
        $("canvasPrivacyOverlay").classList.add("hidden");

        // Show placeholder
        placeholder.classList.remove("hidden");

        // Show waiting buttons (Scan + Reset)
        showWaitingButtons();
      }

      function stopScanning() {
        const video = $("video");
        const placeholder = $("scanPlaceholder");
        const overlay = $("scannerOverlay");
        const canvas = $("canvas");

        // Stop video stream
        if (videoStream) {
          videoStream.getTracks().forEach((track) => track.stop());
          videoStream = null;
        }

        video.srcObject = null;

        // Show placeholder, hide video, overlay and canvas
        placeholder.classList.remove("hidden");
        video.classList.remove("active");
        canvas.classList.remove("active");
        overlay.classList.add("hidden");

        // Hide privacy overlay
        $("canvasPrivacyOverlay").classList.add("hidden");

        // Show waiting buttons
        showWaitingButtons();
      }

      function copyResult() {
        const scanResult = $("scanResult");
        const text = scanResult.textContent;

        navigator.clipboard
          .writeText(text)
          .then(() => {
            showToast("Copied!", "success", 2000);
          })
          .catch((error) => {
            console.error("Copy failed:", error);
            // Fallback for older browsers
            const textarea = document.createElement("textarea");
            textarea.value = text;
            textarea.style.position = "fixed";
            textarea.style.opacity = "0";
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
            showToast("Copied!", "success", 2000);
          });
      }

      // ========================================
      // Section B: Scan QR Code
      // ========================================
      // Button state management
      function showWaitingButtons() {
        $("scanBtn").classList.remove("hidden");
        $("uploadBtn").classList.remove("hidden");
        $("waitingResetBtn").classList.remove("hidden");
        $("cancelBtn").classList.add("hidden");
        $("confirmBtn").classList.add("hidden");
        $("resultResetBtn").classList.add("hidden");
        $("resultCopyBtn").classList.add("hidden");
      }

      function showScanningButtons() {
        $("scanBtn").classList.add("hidden");
        $("uploadBtn").classList.add("hidden");
        $("waitingResetBtn").classList.add("hidden");
        $("cancelBtn").classList.remove("hidden");
        $("confirmBtn").classList.remove("hidden");
        $("resultResetBtn").classList.add("hidden");
        $("resultCopyBtn").classList.add("hidden");
      }

      function showResultButtons() {
        $("scanBtn").classList.add("hidden");
        $("uploadBtn").classList.add("hidden");
        $("waitingResetBtn").classList.add("hidden");
        $("cancelBtn").classList.add("hidden");
        $("confirmBtn").classList.add("hidden");
        $("resultResetBtn").classList.remove("hidden");
        $("resultCopyBtn").classList.remove("hidden");
      }

      function reloadPage() {
        window.location.reload();
      }

      // ========================================
      // Toast Notification Function
      // ========================================
      function showToast(message, type = "info", duration = 3000) {
        const toast = $("toast");

        // Clear existing timer if any
        if (window.toastTimer) {
          clearTimeout(window.toastTimer);
        }

        // Set message and type
        toast.textContent = message;
        toast.className = `toast toast-${type} text-muted`;

        // Show toast with animation
        setTimeout(() => {
          toast.classList.add("toast-hide");
          window.toastTimer = setTimeout(() => {
            toast.classList.add("hidden");
            toast.classList.remove("toast-hide");
          }, 300);
        }, duration);
      }

      // ========================================
      // Visibility Toggle Functions
      // ========================================
      function hideInputContent() {
        const textInput = $("textInput");
        const toggleBtn = $("toggleInputBtn");

        if (!textInput.classList.contains("content-hidden")) {
          textInput.classList.add("content-hidden");
          toggleBtn.textContent = "ğŸ‘ï¸â€ğŸ—¨ï¸";
          toggleBtn.title = "Show content";
        }
      }

      function showInputContent() {
        const textInput = $("textInput");
        const toggleBtn = $("toggleInputBtn");

        if (textInput.classList.contains("content-hidden")) {
          textInput.classList.remove("content-hidden");
          toggleBtn.textContent = "ğŸ‘ï¸";
          toggleBtn.title = "Hide content";
        }
      }

      function toggleInputVisibility() {
        const textInput = $("textInput");
        if (textInput.classList.contains("content-hidden")) {
          showInputContent();
        } else {
          hideInputContent();
        }
      }

      function toggleResultVisibility() {
        const scanResult = $("scanResult");
        const toggleBtn = $("toggleResultBtn");

        if (scanResult.classList.contains("content-hidden")) {
          // Show content
          scanResult.classList.remove("content-hidden");
          toggleBtn.textContent = "ğŸ‘ï¸";
          toggleBtn.title = "Hide content";
        } else {
          // Hide content
          scanResult.classList.add("content-hidden");
          toggleBtn.textContent = "ğŸ‘ï¸â€ğŸ—¨ï¸";
          toggleBtn.title = "Show content";
        }
      }

      // ========================================
      // Crypto: Parameter Configuration
      // ========================================
      const PBKDF2_ITERS = 120_000;
      const SALT_BYTES = 16;
      const IV_BYTES = 12;

      // ========================================
      // Encoding tool
      // ========================================
      const enc = new TextEncoder();
      const dec = new TextDecoder();

      function b64encode(buf) {
        return btoa(String.fromCharCode(...new Uint8Array(buf)));
      }
      function b64decode(str) {
        return Uint8Array.from(atob(str), (c) => c.charCodeAt(0)).buffer;
      }

      // =======================
      // OTP
      // =======================
      function generateOtp() {
        const arr = new Uint8Array(8);
        crypto.getRandomValues(arr);
        return Array.from(arr, (x) => x % 10);
      }

      function otpToString(nums) {
        // Format as 1234-5678 (two groups of 4 digits)
        const first = nums.slice(0, 4).join("");
        const second = nums.slice(4, 8).join("");
        return `${first}-${second}`;
      }

      // =======================
      // Key Derivation
      // =======================
      async function deriveKey(passStr, salt) {
        const keyMaterial = await crypto.subtle.importKey(
          "raw",
          enc.encode(passStr),
          "PBKDF2",
          false,
          ["deriveKey"]
        );

        return crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt,
            iterations: PBKDF2_ITERS,
            hash: "SHA-256",
          },
          keyMaterial,
          { name: "AES-GCM", length: 256 },
          false,
          ["encrypt", "decrypt"]
        );
      }

      async function encryptOnce(plaintext, otpNums) {
        const salt = crypto.getRandomValues(new Uint8Array(SALT_BYTES));
        const iv = crypto.getRandomValues(new Uint8Array(IV_BYTES));

        const key = await deriveKey(otpToString(otpNums), salt);

        const ct = await crypto.subtle.encrypt(
          { name: "AES-GCM", iv },
          key,
          enc.encode(plaintext)
        );

        return [
          "reed:v1",
          b64encode(salt.buffer),
          b64encode(iv.buffer),
          b64encode(ct),
        ].join(".");
      }

      async function decryptOnce(packed, otpNums) {
        const [ver, saltB64, ivB64, ctB64] = packed.split(".");
        if (ver !== "reed:v1") throw new Error("Unsupported format");

        const salt = new Uint8Array(b64decode(saltB64));
        const iv = new Uint8Array(b64decode(ivB64));
        const ct = b64decode(ctB64);

        const key = await deriveKey(otpToString(otpNums), salt);

        const pt = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv },
          key,
          ct
        );

        return dec.decode(pt);
      }

      // ========================================
      // Security: Prevent right-click on entire page
      // ========================================
      document.addEventListener("contextmenu", function (e) {
        e.preventDefault();
        return false;
      });

      // ========================================
      // Character counter for text input
      // ========================================
      const textInput = $("textInput");
      const charCount = $("charCount");

      textInput.addEventListener("input", function () {
        charCount.textContent = textInput.value.length;
      });

      // ========================================
      // OTP Input Auto-focus and Navigation
      // ========================================
      function initOtpInputs() {
        for (let i = 0; i < 8; i++) {
          const input = $(`otp${i}`);

          // Auto-focus to next input on digit entry
          input.addEventListener("input", function (e) {
            const value = e.target.value;

            // Only allow single digit 0-9
            if (value.length > 1) {
              e.target.value = value.charAt(0);
            }

            // Validate digit
            if (value && !/^[0-9]$/.test(value)) {
              e.target.value = "";
              return;
            }

            // Auto-focus next input if digit entered
            if (value && i < 7) {
              $(`otp${i + 1}`).focus();
            }
          });

          // Handle backspace and navigation
          input.addEventListener("keydown", function (e) {
            // Backspace: clear current or move to previous
            if (e.key === "Backspace") {
              if (!e.target.value && i > 0) {
                e.preventDefault();
                $(`otp${i - 1}`).focus();
              }
            }
            // Arrow left: move to previous
            else if (e.key === "ArrowLeft" && i > 0) {
              e.preventDefault();
              $(`otp${i - 1}`).focus();
            }
            // Arrow right: move to next
            else if (e.key === "ArrowRight" && i < 7) {
              e.preventDefault();
              $(`otp${i + 1}`).focus();
            }
          });

          // Handle paste
          input.addEventListener("paste", function (e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData("text").trim();

            // Remove dashes and spaces
            const digits = pastedData.replace(/[-\s]/g, "");

            // Validate and fill inputs
            if (/^\d{8}$/.test(digits)) {
              for (let j = 0; j < 8; j++) {
                $(`otp${j}`).value = digits.charAt(j);
              }
              $("otp7").focus();
            }
          });
        }
      }

      // Initialize OTP inputs
      initOtpInputs();

      // ========================================
      // Cleanup on page unload
      // ========================================
      window.addEventListener("beforeunload", function () {
        if (videoStream) {
          videoStream.getTracks().forEach((track) => track.stop());
        }
      });

      // ========================================
      // Theme Toggle Functionality
      // ========================================
      function getPreferredTheme() {
        // Check localStorage first (with Safari private mode protection)
        try {
          const savedTheme = localStorage.getItem("theme");
          if (savedTheme) {
            return savedTheme;
          }
        } catch (e) {
          // Safari private mode or localStorage disabled
          console.warn("localStorage not available:", e.name);
        }

        // Fall back to system preference
        return window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light";
      }

      function setTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);

        // Save to localStorage (with Safari private mode protection)
        try {
          localStorage.setItem("theme", theme);
        } catch (e) {
          // Safari private mode: QuotaExceededError
          // User can still switch themes, just won't persist on refresh
          console.warn("localStorage not available:", e.name);
        }

        // Update icon
        const icon = $("themeIcon");
        icon.textContent = theme === "dark" ? "â˜€ï¸" : "ğŸŒ™";
      }

      function toggleTheme() {
        const currentTheme =
          document.documentElement.getAttribute("data-theme") ||
          getPreferredTheme();
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        setTheme(newTheme);
      }

      // Initialize theme on page load
      (function initTheme() {
        const theme = getPreferredTheme();
        setTheme(theme);
      })();

      // Listen for system theme changes
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (e) => {
          // Only auto-switch if user hasn't manually set a preference
          let hasManualTheme = false;
          try {
            hasManualTheme = !!localStorage.getItem("theme");
          } catch (e) {
            // Safari private mode or localStorage disabled
            console.warn("localStorage not available:", e.name);
          }

          if (!hasManualTheme) {
            setTheme(e.matches ? "dark" : "light");
          }
        });
    </script>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden"></div>
  </body>
</html>
