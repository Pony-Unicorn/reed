<!doctype html>
<html lang="zh-CN" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Reed â€” End-to-End Encrypted Transfer</title>
    <meta
      name="description"
      content="Secure peer-to-peer transfer tool for end-to-end encrypted transmission of passwords, private keys, mnemonics, and files"
    />

    <!-- 1. DaisyUI CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@5"
      rel="stylesheet"
      type="text/css"
    />

    <!-- 2. Tailwind -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- 3. Alpine.js -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.8/dist/cdn.min.js"
    ></script>

    <!-- 4. Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@3.0.0/dist/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
      /* Custom styles that are hard to do with pure Tailwind/DaisyUI */
      .qr-display-area {
        min-height: 306px;
        user-select: none;
      }
      .scanner-container-area {
        min-height: 306px;
      }
      .canvas-privacy-overlay {
        background: repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 1) 0px,
          rgba(0, 0, 0, 1) 12px,
          transparent 12px,
          transparent 24px
        );
      }
      [x-cloak] {
        display: none !important;
      }

      /* Flip video only on desktop devices */
      @media (hover: hover) and (pointer: fine) {
        video {
          transform: scaleX(-1);
        }
      }
    </style>
  </head>
  <body class="min-h-screen bg-base-200 text-base-content font-sans">
    <div x-data="indexPage" x-init="init()" @contextmenu.prevent>
      <!-- Header -->
      <header class="bg-base-100 border-b border-base-300 py-4 shadow-sm">
        <div
          class="container mx-auto px-4 flex justify-between items-center max-w-6xl"
        >
          <div class="flex items-center gap-4">
            <img src="./logo.png" alt="Reed Logo" class="w-12 h-14" />
            <div>
              <h1 class="text-2xl font-bold tracking-tight">Reed</h1>
              <p class="text-sm text-base-content/70">
                air-gapped conduit for sensitive data.
              </p>
            </div>
          </div>
          <button
            class="btn btn-circle btn-ghost border-2 border-base-300"
            @click="toggleTheme()"
            :title="'Toggle theme'"
          >
            <iconify-icon
              :icon="theme === 'dark' ? 'lucide:sun' : 'lucide:moon'"
              class="text-xl"
            ></iconify-icon>
          </button>
        </div>
      </header>

      <!-- Main Content -->
      <main class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- Section A: Generate QR Code -->
          <section class="card bg-base-100 shadow-xl border border-base-300">
            <div class="card-body gap-4">
              <h2 class="card-title text-2xl font-bold mb-2">
                ğŸ“¤ Generate QR Code
              </h2>

              <div
                class="qr-display-area relative flex flex-col justify-center items-center bg-base-200 rounded-lg border-2 border-dashed border-base-300 overflow-hidden"
              >
                <div x-show="!qrGenerated" class="text-sm text-base-content/50">
                  Waiting generation...
                </div>
                <div
                  id="qrcode"
                  x-show="qrGenerated && showQr"
                  class="p-2 bg-white rounded-lg"
                ></div>
                <div
                  x-show="qrGenerated && !showQr"
                  class="text-sm text-base-content/50 italic"
                >
                  QR Code Hidden
                </div>
              </div>

              <button
                x-show="qrGenerated"
                class="btn btn-outline btn-sm w-full"
                @click="showQr = !showQr"
              >
                <iconify-icon
                  :icon="showQr ? 'lucide:eye-off' : 'lucide:eye'"
                  class="mr-1"
                ></iconify-icon>
                <span x-text="showQr ? 'Hide QR' : 'Show QR'"></span>
              </button>

              <div class="relative">
                <button
                  class="absolute top-2 right-2 z-10 btn btn-ghost btn-xs text-base-content/50 hover:text-primary"
                  @click="showInput = !showInput"
                >
                  <iconify-icon
                    :icon="showInput ? 'lucide:eye-off' : 'lucide:eye'"
                    class="text-lg"
                  ></iconify-icon>
                </button>
                <textarea
                  x-model="textInput"
                  class="textarea textarea-bordered w-full h-32 pr-10 focus:textarea-primary transition-all duration-200"
                  :class="{'blur-md select-none pointer-events-none': !showInput}"
                  placeholder="text, password, privateKey, mnemonic, etc."
                  autocomplete="off"
                  spellcheck="false"
                ></textarea>
                <div
                  class="text-xs text-base-content/50 mt-1 flex justify-between"
                >
                  <span
                    ><span x-text="textInput.length"></span> / 200
                    characters</span
                  >
                </div>
              </div>

              <!-- Encryption Options -->
              <div
                class="flex items-center justify-between bg-base-200 p-2 rounded-lg border border-base-300"
              >
                <div class="flex items-center gap-2">
                  <span
                    class="font-mono text-sm font-semibold text-primary"
                    x-text="otpDisplay"
                  ></span>
                  <button
                    x-show="isEncryptEnabled"
                    class="btn btn-ghost btn-xs text-base-content/50 hover:text-primary"
                    @click="toggleOtpVisibility()"
                  >
                    <iconify-icon
                      :icon="showOtp ? 'lucide:eye-off' : 'lucide:eye'"
                    ></iconify-icon>
                  </button>
                </div>
                <label
                  class="flex items-center gap-2 cursor-pointer label py-0"
                >
                  <span class="label-text text-sm">ğŸ” Encrypt</span>
                  <input
                    type="checkbox"
                    x-model="isEncryptEnabled"
                    @change="handleEncryptionToggle()"
                    class="checkbox checkbox-primary checkbox-sm"
                  />
                </label>
              </div>

              <div class="flex gap-2 justify-between mt-2">
                <button class="btn btn-outline btn-sm" @click="resetPage()">
                  <iconify-icon icon="lucide:trash-2"></iconify-icon> Reset
                </button>
                <button
                  class="btn btn-primary btn-sm px-6"
                  @click="generateQRCode()"
                  :disabled="!textInput.trim() || isLoading"
                >
                  <span
                    x-show="isLoading"
                    class="loading loading-spinner loading-xs"
                  ></span>
                  <iconify-icon
                    x-show="!isLoading"
                    icon="lucide:qr-code"
                  ></iconify-icon>
                  Gen QR
                </button>
              </div>
            </div>
          </section>

          <!-- Section B: Scan QR Code -->
          <section class="card bg-base-100 shadow-xl border border-base-300">
            <div class="card-body gap-4">
              <h2 class="card-title text-2xl font-bold mb-2">
                ğŸ“¥ Scan QR Code
              </h2>

              <div
                class="scanner-container-area relative flex justify-center items-center bg-base-200 rounded-lg border-2 border-dashed border-base-300 overflow-hidden bg-neutral"
              >
                <div
                  x-show="scanState === 'idle'"
                  class="text-sm text-neutral-content/50"
                >
                  Waiting scanning...
                </div>

                <video
                  x-ref="video"
                  autoplay
                  playsinline
                  x-show="scanState === 'scanning'"
                  class="w-full h-full object-contain"
                ></video>
                <canvas
                  x-ref="canvas"
                  x-show="scanState === 'result'"
                  class="w-full h-full object-contain"
                ></canvas>

                <div
                  x-show="scanState === 'result' && isPrivacyOverlayVisible"
                  class="absolute inset-0 canvas-privacy-overlay z-10 pointer-events-none rounded-lg opacity-50"
                ></div>

                <!-- Scanner Overlay -->
                <div
                  x-show="scanState === 'scanning'"
                  class="absolute inset-0 flex items-center justify-center pointer-events-none z-20"
                >
                  <div
                    class="w-64 h-64 border-2 border-primary rounded-lg relative"
                  >
                    <div
                      class="absolute -top-1 -left-1 w-8 h-8 border-t-4 border-l-4 border-primary"
                    ></div>
                    <div
                      class="absolute -top-1 -right-1 w-8 h-8 border-t-4 border-r-4 border-primary"
                    ></div>
                    <div
                      class="absolute -bottom-1 -left-1 w-8 h-8 border-b-4 border-l-4 border-primary"
                    ></div>
                    <div
                      class="absolute -bottom-1 -right-1 w-8 h-8 border-b-4 border-r-4 border-primary"
                    ></div>
                  </div>
                </div>
              </div>

              <!-- Decryption Panel -->
              <div
                x-show="showDecryptionPanel"
                x-cloak
                class="flex flex-col gap-4 bg-base-200 p-4 rounded-lg border border-base-300"
              >
                <div class="flex justify-center gap-1">
                  <template x-for="(digit, index) in 8" :key="index">
                    <div class="flex items-center gap-1">
                      <input
                        type="text"
                        maxlength="1"
                        inputmode="numeric"
                        class="w-8 h-12 text-center text-lg font-bold bg-base-100 border-2 border-base-300 rounded focus:border-primary outline-none transition-all"
                        x-model="otpInputs[index]"
                        @input="handleOtpInput($event, index)"
                        @keydown="handleOtpKeydown($event, index)"
                        @paste="handleOtpPaste($event)"
                        :id="'otp-' + index"
                      />
                      <span
                        x-show="index === 3"
                        class="font-bold text-base-content/30 mx-0.5"
                        >-</span
                      >
                    </div>
                  </template>
                </div>
                <div class="flex items-center justify-between">
                  <div
                    class="text-sm font-semibold text-primary flex items-center gap-1"
                  >
                    <iconify-icon icon="lucide:unlock"></iconify-icon> Enter
                    8-digit OTP
                  </div>
                  <button
                    class="btn btn-accent btn-sm"
                    @click="decryptResult()"
                    :disabled="isDecrypting"
                  >
                    <span
                      x-show="isDecrypting"
                      class="loading loading-spinner loading-xs"
                    ></span>
                    Unlock
                  </button>
                </div>
              </div>

              <!-- Result Box -->
              <div class="relative group">
                <button
                  x-show="scanState === 'result' && scanResult"
                  class="absolute top-2 right-2 z-10 btn btn-ghost btn-xs text-base-content/50 hover:text-primary"
                  @click="showResult = !showResult"
                >
                  <iconify-icon
                    :icon="showResult ? 'lucide:eye-off' : 'lucide:eye'"
                    class="text-lg"
                  ></iconify-icon>
                </button>
                <div
                  class="bg-base-200 p-4 rounded-lg border-2 border-accent/20 min-h-[100px] break-all relative"
                >
                  <p
                    x-show="!scanResult"
                    class="text-sm text-base-content/50 italic"
                  >
                    Waiting result...
                  </p>
                  <p
                    x-show="scanResult"
                    x-text="scanResult"
                    class="text-base-content transition-all duration-200"
                    :class="{'blur-md select-none pointer-events-none': !showResult}"
                  ></p>
                </div>
              </div>

              <div class="flex gap-2 mt-2 justify-between flex-wrap">
                <!-- Waiting State -->
                <template x-if="scanState === 'idle'">
                  <div class="flex gap-2 w-full justify-between">
                    <button class="btn btn-outline btn-sm" @click="resetPage()">
                      <iconify-icon icon="lucide:trash-2"></iconify-icon> Reset
                    </button>
                    <div class="flex gap-2">
                      <button
                        class="btn btn-ghost btn-sm bg-primary/10 text-primary border-primary/20 hover:bg-primary hover:text-white"
                        @click="$refs.imageInput.click()"
                      >
                        <iconify-icon icon="lucide:image"></iconify-icon> Upload
                      </button>
                      <button
                        class="btn btn-primary btn-sm"
                        @click="startScanning()"
                      >
                        <iconify-icon icon="lucide:camera"></iconify-icon> Scan
                        QR
                      </button>
                    </div>
                  </div>
                </template>
                <input
                  type="file"
                  x-ref="imageInput"
                  accept="image/*"
                  class="hidden"
                  @change="handleImageUpload($event)"
                />

                <!-- Scanning State -->
                <template x-if="scanState === 'scanning'">
                  <div class="flex gap-2 w-full justify-between">
                    <button
                      class="btn btn-outline btn-sm"
                      @click="stopScanning()"
                    >
                      <iconify-icon icon="lucide:x"></iconify-icon> Cancel
                    </button>
                    <button
                      class="btn btn-accent btn-sm px-6"
                      @click="captureAndDecode()"
                    >
                      <iconify-icon icon="lucide:check"></iconify-icon> Confirm
                    </button>
                  </div>
                </template>

                <!-- Result State -->
                <template x-if="scanState === 'result'">
                  <div class="flex gap-2 w-full justify-between">
                    <button class="btn btn-outline btn-sm" @click="resetPage()">
                      <iconify-icon icon="lucide:trash-2"></iconify-icon> Reset
                    </button>
                    <button
                      class="btn btn-ghost btn-sm bg-primary/10 text-primary border-primary/20 hover:bg-primary hover:text-white"
                      @click="copyResult()"
                    >
                      <iconify-icon icon="lucide:copy"></iconify-icon> Copy
                    </button>
                  </div>
                </template>
              </div>
            </div>
          </section>
        </div>
      </main>

      <!-- FAQ Section -->
      <section class="bg-base-100 border-t border-base-300 py-16 mt-16">
        <div class="container mx-auto px-4 max-w-4xl">
          <h2 class="text-3xl font-bold mb-10 text-center">
            â“ FAQ - å¸¸è§é—®é¢˜
          </h2>

          <div class="join join-vertical w-full">
            <div
              class="collapse collapse-arrow join-item border border-base-300"
            >
              <input type="radio" name="faq-accordion" checked="checked" />
              <div class="collapse-title text-lg font-semibold">
                Q: è¿™ä¸ªå·¥å…·å®‰å…¨å—ï¼Ÿ
              </div>
              <div class="collapse-content">
                <p class="mb-2">
                  Reed
                  æ˜¯ä¸€ä¸ªå®Œå…¨ç¦»çº¿è¿è¡Œçš„å·¥å…·ï¼Œä¸ä¼šå°†æ‚¨çš„æ•°æ®å‘é€åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚æ‰€æœ‰æ“ä½œéƒ½åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å®Œæˆã€‚ä¸ºäº†è¿›ä¸€æ­¥æå‡å®‰å…¨æ€§ï¼Œå»ºè®®ï¼š
                </p>
                <ul class="list-disc pl-5 gap-1 flex flex-col">
                  <li>ä½¿ç”¨æµè§ˆå™¨çš„æ— ç—•/éšç§æ¨¡å¼</li>
                  <li>åœ¨ç¦»çº¿ç¯å¢ƒä¸­ä½¿ç”¨</li>
                  <li>é‡‡ç”¨åˆ†æ®µä¼ è¾“çš„æ–¹å¼å¤„ç†æ•æ„Ÿä¿¡æ¯</li>
                  <li>é¿å…ä½¿ç”¨å‰ªè´´æ¿å¤åˆ¶ç²˜è´´</li>
                </ul>
              </div>
            </div>

            <div
              class="collapse collapse-arrow join-item border border-base-300"
            >
              <input type="radio" name="faq-accordion" />
              <div class="collapse-title text-lg font-semibold">
                Q: ä¸ºä»€ä¹ˆè¦é¿å…ä½¿ç”¨å‰ªè´´æ¿ï¼Ÿ
              </div>
              <div class="collapse-content">
                <p>
                  è®¸å¤šè½¯ä»¶å¯èƒ½ä¼šç›‘å¬æˆ–åŒæ­¥å‰ªè´´æ¿å†…å®¹ï¼ŒåŒ…æ‹¬è¾“å…¥æ³•ï¼ˆç‰¹åˆ«æ˜¯äº‘è¾“å…¥æ³•ï¼‰ã€ç¿»è¯‘å·¥å…·ã€å‰ªè´´æ¿å¢å¼ºå·¥å…·ç­‰ã€‚è™½ç„¶è¿™äº›è½¯ä»¶é€šå¸¸æ— æ³•è¯»å–å±å¹•æˆ–æ‘„åƒå¤´å†…å®¹ï¼Œä½†å¯ä»¥åœ¨æ‚¨å¤åˆ¶æ–‡æœ¬æ—¶è·å–å®Œæ•´å†…å®¹ã€‚å› æ­¤ï¼Œé¿å…è®©æ•æ„Ÿä¿¡æ¯è¿›å…¥å‰ªè´´æ¿æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é£é™©é™ä½æªæ–½ã€‚
                </p>
              </div>
            </div>

            <div
              class="collapse collapse-arrow join-item border border-base-300"
            >
              <input type="radio" name="faq-accordion" />
              <div class="collapse-title text-lg font-semibold">
                Q: ä»€ä¹ˆæ˜¯åˆ†æ®µä¼ è¾“ï¼Ÿä¸ºä»€ä¹ˆæ¨èä½¿ç”¨ï¼Ÿ
              </div>
              <div class="collapse-content">
                <p class="mb-2">
                  åˆ†æ®µä¼ è¾“æ˜¯æŒ‡å°†é•¿çš„ç§é’¥æˆ–åŠ©è®°è¯æ‹†åˆ†æˆå¤šä¸ªè¾ƒçŸ­çš„ç‰‡æ®µï¼ˆå»ºè®® 3-5
                  æ®µï¼‰ï¼Œåˆ†åˆ«ç”ŸæˆäºŒç»´ç å¹¶ä¼ è¾“ã€‚è¿™ç§æ–¹å¼çš„ä¼˜åŠ¿æ˜¯ï¼š
                </p>
                <ul class="list-disc pl-5 gap-1 flex flex-col">
                  <li>é™ä½å•æ¬¡æ³„éœ²çš„é£é™©</li>
                  <li>äºŒç»´ç æ›´æ¸…æ™°ï¼Œæ‰«ææˆåŠŸç‡æ›´é«˜</li>
                  <li>å¯ä»¥çµæ´»é€‰æ‹©æŸäº›ç‰‡æ®µæ‰‹åŠ¨è¾“å…¥ï¼Œè€Œä¸é€šè¿‡äºŒç»´ç </li>
                  <li>å³ä½¿éƒ¨åˆ†ç‰‡æ®µè¢«æˆªè·ï¼Œä¹Ÿæ— æ³•è·å¾—å®Œæ•´ä¿¡æ¯</li>
                </ul>
              </div>
            </div>

            <div
              class="collapse collapse-arrow join-item border border-base-300"
            >
              <input type="radio" name="faq-accordion" />
              <div class="collapse-title text-lg font-semibold">
                Q: å¦‚ä½•ä½¿ç”¨æ— ç—•æ¨¡å¼ï¼Ÿ
              </div>
              <div class="collapse-content">
                <p class="mb-2">åœ¨ä¸»æµæµè§ˆå™¨ä¸­æ‰“å¼€æ— ç—•/éšç§æ¨¡å¼çš„å¿«æ·é”®ï¼š</p>
                <ul class="list-disc pl-5 gap-1 flex flex-col">
                  <li>
                    <strong>Chrome / Edge</strong>: Ctrl + Shift + N (Win/Linux)
                    æˆ– Cmd + Shift + N (Mac)
                  </li>
                  <li>
                    <strong>Firefox</strong>: Ctrl + Shift + P (Win/Linux) æˆ–
                    Cmd + Shift + P (Mac)
                  </li>
                  <li><strong>Safari</strong>: Cmd + Shift + N (Mac)</li>
                </ul>
                <p class="mt-2 text-sm italic opacity-70">
                  æ— ç—•æ¨¡å¼å¯ä»¥é˜²æ­¢æµè§ˆå™¨æ‰©å±•è®¿é—®é¡µé¢å†…å®¹ï¼Œå¹¶åœ¨ä¼šè¯ç»“æŸåè‡ªåŠ¨æ¸…ç†æ‰€æœ‰æ•°æ®ã€‚
                </p>
              </div>
            </div>

            <div
              class="collapse collapse-arrow join-item border border-base-300"
            >
              <input type="radio" name="faq-accordion" />
              <div class="collapse-title text-lg font-semibold">
                Q: ä¸ºä»€ä¹ˆé™åˆ¶ 200 å­—ç¬¦ï¼Ÿ
              </div>
              <div class="collapse-content">
                <p class="mb-2">
                  200
                  å­—ç¬¦çš„é™åˆ¶æ˜¯ä¸ºäº†ç¡®ä¿äºŒç»´ç çš„æ‰«æè´¨é‡ã€‚è¾ƒé•¿çš„å†…å®¹ä¼šå¯¼è‡´äºŒç»´ç å˜å¾—å¯†é›†ï¼Œåœ¨
                  300x300 åƒç´ çš„æ˜¾ç¤ºå°ºå¯¸ä¸‹éš¾ä»¥æ‰«æã€‚200
                  å­—ç¬¦è¶³ä»¥æ»¡è¶³å¤§å¤šæ•°ä½¿ç”¨åœºæ™¯ï¼ŒåŒ…æ‹¬ï¼š
                </p>
                <ul class="list-disc pl-5 gap-1 flex flex-col">
                  <li>å¯†ç ï¼šé€šå¸¸ 8-64 å­—ç¬¦</li>
                  <li>æ¯”ç‰¹å¸ç§é’¥ï¼š52-64 å­—ç¬¦</li>
                  <li>åŠ©è®°è¯ï¼ˆ12 è¯ï¼‰ï¼šçº¦ 150 å­—ç¬¦</li>
                  <li>API Tokenï¼šé€šå¸¸ 32-256 å­—ç¬¦</li>
                </ul>
                <p class="mt-2 text-sm italic opacity-70">
                  å¯¹äºæ›´é•¿çš„å†…å®¹ï¼ˆå¦‚ 24 è¯åŠ©è®°è¯ï¼‰ï¼Œå»ºè®®ä½¿ç”¨åˆ†æ®µä¼ è¾“çš„æ–¹å¼ã€‚
                </p>
              </div>
            </div>

            <div
              class="collapse collapse-arrow join-item border border-base-300"
            >
              <input type="radio" name="faq-accordion" />
              <div class="collapse-title text-lg font-semibold">
                Q: é‡åˆ°é—®é¢˜æˆ–æœ‰å»ºè®®å¦‚ä½•åé¦ˆï¼Ÿ
              </div>
              <div class="collapse-content">
                <p>æ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š</p>
                <div class="flex gap-6 mt-4 justify-center">
                  <a
                    href="https://github.com/Pony-Unicorn/reed/issues"
                    target="_blank"
                    class="btn btn-outline btn-sm gap-2"
                  >
                    <iconify-icon icon="lucide:github"></iconify-icon> GitHub
                    Issues
                  </a>
                  <a
                    href="https://x.com/shunfengge"
                    target="_blank"
                    class="btn btn-outline btn-sm gap-2"
                  >
                    <iconify-icon icon="lucide:twitter"></iconify-icon>
                    Twitter/X
                  </a>
                </div>
              </div>
            </div>

            <div
              class="collapse collapse-arrow join-item border border-base-300"
            >
              <input type="radio" name="faq-accordion" />
              <div class="collapse-title text-lg font-semibold text-error">
                âš ï¸ å…è´£å£°æ˜
              </div>
              <div class="collapse-content text-error">
                <p>
                  è¯·ç¡®ä¿åœ¨å®‰å…¨ã€å¯ä¿¡çš„ç¯å¢ƒä¸­ä½¿ç”¨æœ¬å·¥å…·ã€‚ä»»ä½•ç§é’¥ä¸€æ—¦æ³„éœ²ï¼Œå‡å¯èƒ½å¯¼è‡´èµ„äº§æ°¸ä¹…æŸå¤±ã€‚æœ¬å·¥å…·ä»…æä¾›æŠ€æœ¯æ–¹æ¡ˆï¼Œä½¿ç”¨è€…éœ€è‡ªè¡Œæ‰¿æ‹…å®‰å…¨è´£ä»»ã€‚
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Toast (Handled by shared.js store) -->
      <div class="toast toast-top toast-center z-50">
        <template x-for="t in $store.toast.items" :key="t.id">
          <div x-transition class="alert shadow-lg" :class="'alert-' + t.type">
            <span x-text="t.message"></span>
          </div>
        </template>
      </div>
    </div>

    <script>
      // ========================================
      // Global Config & Utils (Formerly shared.js)
      // ========================================
      const CONFIG = {
        PBKDF2_ITERS: 120_000,
        SALT_BYTES: 16,
        IV_BYTES: 12,
        MAX_CHAR_COUNT: 200,
      };

      const enc = new TextEncoder();
      const dec = new TextDecoder();

      const cryptoUtils = {
        b64encode(buf) {
          return btoa(String.fromCharCode(...new Uint8Array(buf)));
        },
        b64decode(str) {
          return Uint8Array.from(atob(str), (c) => c.charCodeAt(0)).buffer;
        },
        generateOtp() {
          const arr = new Uint8Array(8);
          crypto.getRandomValues(arr);
          return Array.from(arr, (x) => x % 10);
        },
        otpToString(nums) {
          const first = nums.slice(0, 4).join("");
          const second = nums.slice(4, 8).join("");
          return `${first}-${second}`;
        },
        async deriveKey(passStr, salt) {
          const keyMaterial = await crypto.subtle.importKey(
            "raw",
            enc.encode(passStr),
            "PBKDF2",
            false,
            ["deriveKey"],
          );
          return crypto.subtle.deriveKey(
            {
              name: "PBKDF2",
              salt,
              iterations: CONFIG.PBKDF2_ITERS,
              hash: "SHA-256",
            },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            false,
            ["encrypt", "decrypt"],
          );
        },
        async encryptOnce(plaintext, otpNums) {
          const salt = crypto.getRandomValues(
            new Uint8Array(CONFIG.SALT_BYTES),
          );
          const iv = crypto.getRandomValues(new Uint8Array(CONFIG.IV_BYTES));
          const key = await this.deriveKey(this.otpToString(otpNums), salt);
          const ct = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv },
            key,
            enc.encode(plaintext),
          );
          return [
            "reed:v1",
            this.b64encode(salt.buffer),
            this.b64encode(iv.buffer),
            this.b64encode(ct),
          ].join(".");
        },
        async decryptOnce(packed, otpNums) {
          const [ver, saltB64, ivB64, ctB64] = packed.split(".");
          if (ver !== "reed:v1") throw new Error("Unsupported format");
          const salt = new Uint8Array(this.b64decode(saltB64));
          const iv = new Uint8Array(this.b64decode(ivB64));
          const ct = this.b64decode(ctB64);
          const key = await this.deriveKey(this.otpToString(otpNums), salt);
          const pt = await crypto.subtle.decrypt(
            { name: "AES-GCM", iv },
            key,
            ct,
          );
          return dec.decode(pt);
        },
      };

      const toast = (msg, type) => Alpine.store("toast").show(msg, type);

      document.addEventListener("alpine:init", () => {
        // Global Store for Toasts
        Alpine.store("toast", {
          items: [],
          show(msg, type = "success") {
            const id = Date.now();
            const alertType =
              type === "info"
                ? "info"
                : type === "warning"
                  ? "warning"
                  : type === "error"
                    ? "error"
                    : "success";
            this.items.push({ id, message: msg, type: alertType });
            if (this.items.length > 5) this.items.shift();
            setTimeout(() => {
              this.items = this.items.filter((t) => t.id !== id);
            }, 3000);
          },
        });

        Alpine.data("indexPage", () => ({
          // -- State --
          theme: "light",
          isLoading: false,
          isDecrypting: false,

          // Generate Section
          qrGenerated: false,
          showQr: true,
          textInput: "",
          showInput: true,
          isEncryptEnabled: false,
          currentOtp: null,
          otpActualValue: null,
          showOtp: false,
          otpAutoHideTimer: null,

          // Scan Section
          scanState: "idle", // idle, scanning, result
          videoStream: null,
          scanResult: "",
          showResult: false,
          encryptedScanResult: null,
          showDecryptionPanel: false,
          otpInputs: Array(8).fill(""),
          isPrivacyOverlayVisible: false,

          // -- Computed --
          get otpDisplay() {
            if (!this.isEncryptEnabled) return "--";
            return this.showOtp ? this.otpActualValue : "â€¢â€¢â€¢â€¢-â€¢â€¢â€¢â€¢";
          },

          // -- Lifecycle --
          init() {
            this.initTheme();
            this.setupThemeListener();
          },

          // -- Theme Logic --
          initTheme() {
            try {
              const savedTheme = localStorage.getItem("theme");
              if (savedTheme) {
                this.theme = savedTheme;
              } else {
                this.theme = window.matchMedia("(prefers-color-scheme: dark)")
                  .matches
                  ? "dark"
                  : "light";
              }
            } catch (e) {
              this.theme = window.matchMedia("(prefers-color-scheme: dark)")
                .matches
                ? "dark"
                : "light";
            }
            document.documentElement.setAttribute("data-theme", this.theme);
          },

          toggleTheme() {
            this.theme = this.theme === "dark" ? "light" : "dark";
            document.documentElement.setAttribute("data-theme", this.theme);
            try {
              localStorage.setItem("theme", this.theme);
            } catch (e) {}
          },

          setupThemeListener() {
            window
              .matchMedia("(prefers-color-scheme: dark)")
              .addEventListener("change", (e) => {
                try {
                  if (!localStorage.getItem("theme")) {
                    this.theme = e.matches ? "dark" : "light";
                    document.documentElement.setAttribute(
                      "data-theme",
                      this.theme,
                    );
                  }
                } catch (err) {}
              });
          },

          // -- Generate Logic --
          handleEncryptionToggle() {
            if (this.isEncryptEnabled) {
              this.currentOtp = cryptoUtils.generateOtp();
              this.otpActualValue = cryptoUtils.otpToString(this.currentOtp);
              this.showOtp = false;
            } else {
              this.currentOtp = null;
              this.otpActualValue = null;
              this.showOtp = false;
              if (this.otpAutoHideTimer) {
                clearTimeout(this.otpAutoHideTimer);
                this.otpAutoHideTimer = null;
              }
            }
          },

          toggleOtpVisibility() {
            if (!this.showOtp) {
              this.showOtp = true;
              if (this.otpAutoHideTimer) clearTimeout(this.otpAutoHideTimer);
              this.otpAutoHideTimer = setTimeout(() => {
                this.showOtp = false;
                this.otpAutoHideTimer = null;
              }, 5000);
            } else {
              this.showOtp = false;
              if (this.otpAutoHideTimer) {
                clearTimeout(this.otpAutoHideTimer);
                this.otpAutoHideTimer = null;
              }
            }
          },

          async generateQRCode() {
            const text = this.textInput.trim();
            if (!text) {
              toast("Enter content", "warning");
              return;
            }

            if (text.length > CONFIG.MAX_CHAR_COUNT) {
              toast(
                `Too long (${text.length}/${CONFIG.MAX_CHAR_COUNT})`,
                "error",
              );
              return;
            }

            this.isLoading = true;
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = "";

            try {
              let contentToEncode = text;
              if (this.isEncryptEnabled && this.currentOtp) {
                contentToEncode = await cryptoUtils.encryptOnce(
                  text,
                  this.currentOtp,
                );
              }

              QRCode.toCanvas(
                qrContainer,
                contentToEncode,
                {
                  width: 300,
                  margin: 4,
                  color: { dark: "#000000", light: "#ffffff" },
                  errorCorrectionLevel: "M",
                },
                (error) => {
                  this.isLoading = false;
                  if (error) {
                    console.error(error);
                    toast("Generation failed", "error");
                    return;
                  }
                  this.qrGenerated = true;
                  this.showQr = true;
                  this.showInput = false;
                },
              );
            } catch (error) {
              this.isLoading = false;
              console.error("Encryption error:", error);
              toast("Encryption failed", "error");
            }
          },

          // -- Scan Logic --
          async startScanning() {
            try {
              this.videoStream = await navigator.mediaDevices.getUserMedia({
                video: {
                  facingMode: "environment",
                  width: { min: 640, ideal: 1280, max: 2560 },
                  height: { min: 640, ideal: 1280, max: 2560 },
                },
                audio: false,
              });

              this.$refs.video.srcObject = this.videoStream;
              this.scanState = "scanning";
            } catch (error) {
              console.error("Camera access error:", error);
              toast("Camera access denied", "error");
            }
          },

          stopScanning() {
            if (this.videoStream) {
              this.videoStream.getTracks().forEach((track) => track.stop());
              this.videoStream = null;
            }
            if (this.$refs.video) this.$refs.video.srcObject = null;
            this.scanState = "idle";
          },

          captureAndDecode() {
            const video = this.$refs.video;
            const canvas = this.$refs.canvas;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const context = canvas.getContext("2d", {
              willReadFrequently: true,
            });
            context.filter = "contrast(120%) brightness(105%)";
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            context.filter = "none";

            const imageData = context.getImageData(
              0,
              0,
              canvas.width,
              canvas.height,
            );
            const code = jsQR(
              imageData.data,
              imageData.width,
              imageData.height,
              {
                inversionAttempts: "attemptBoth",
              },
            );

            if (code) {
              this.processScanResult(code.data);
              this.stopScanning();
              this.scanState = "result";
            } else {
              toast("Not detected, adjust angle", "warning");
            }
          },

          handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith("image/")) {
              if (file) toast("Please select an image file", "error");
              return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
              const img = new Image();
              img.onload = () => {
                const canvas = this.$refs.canvas;
                canvas.width = img.width;
                canvas.height = img.height;
                const context = canvas.getContext("2d", {
                  willReadFrequently: true,
                });
                context.filter = "contrast(120%) brightness(105%)";
                context.drawImage(img, 0, 0, canvas.width, canvas.height);
                context.filter = "none";

                const imageData = context.getImageData(
                  0,
                  0,
                  canvas.width,
                  canvas.height,
                );
                const code = jsQR(
                  imageData.data,
                  imageData.width,
                  imageData.height,
                  {
                    inversionAttempts: "attemptBoth",
                  },
                );

                if (code) {
                  this.processScanResult(code.data);
                  this.scanState = "result";
                  toast("QR code recognized!", "success");
                } else {
                  toast("No QR code found in image", "warning");
                }
              };
              img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            event.target.value = "";
          },

          processScanResult(data) {
            this.isPrivacyOverlayVisible = true;
            if (data.startsWith("reed:v1.")) {
              this.encryptedScanResult = data;
              this.showDecryptionPanel = true;
              this.scanResult = "";
              this.showResult = false;
            } else {
              this.scanResult = data;
              this.showResult = false;
              this.showDecryptionPanel = false;
            }
          },

          async decryptResult() {
            if (!this.encryptedScanResult) return;

            if (this.otpInputs.some((d) => !d)) {
              toast("Enter all 8 digits", "warning");
              return;
            }

            this.isDecrypting = true;
            try {
              const otpNums = this.otpInputs.map((d) => parseInt(d, 10));
              const decryptedText = await cryptoUtils.decryptOnce(
                this.encryptedScanResult,
                otpNums,
              );

              this.scanResult = decryptedText;
              this.showResult = false;
              this.showDecryptionPanel = false;
              this.otpInputs = Array(8).fill("");
              toast("Decrypted!", "success");
            } catch (error) {
              console.error("Decryption error:", error);
              toast("Decryption failed. Check OTP", "error");
            } finally {
              this.isDecrypting = false;
            }
          },

          // -- OTP Inputs Logic --
          handleOtpInput(e, index) {
            const val = e.target.value;
            if (val.length > 1) {
              this.otpInputs[index] = val.charAt(0);
            }
            if (
              this.otpInputs[index] &&
              !/^[0-9]$/.test(this.otpInputs[index])
            ) {
              this.otpInputs[index] = "";
              return;
            }
            if (this.otpInputs[index] && index < 7) {
              document.getElementById(`otp-${index + 1}`).focus();
            }
          },

          handleOtpKeydown(e, index) {
            if (e.key === "Backspace") {
              if (!this.otpInputs[index] && index > 0) {
                document.getElementById(`otp-${index - 1}`).focus();
              }
            } else if (e.key === "ArrowLeft" && index > 0) {
              document.getElementById(`otp-${index - 1}`).focus();
            } else if (e.key === "ArrowRight" && index < 7) {
              document.getElementById(`otp-${index + 1}`).focus();
            }
          },

          handleOtpPaste(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData("text").trim();
            const digits = pastedData.replace(/[-\s]/g, "");
            if (/^\d{8}$/.test(digits)) {
              for (let i = 0; i < 8; i++) {
                this.otpInputs[i] = digits.charAt(i);
              }
              document.getElementById("otp-7").focus();
            }
          },

          copyResult() {
            if (!this.scanResult) return;
            navigator.clipboard
              .writeText(this.scanResult)
              .then(() => toast("Copied!", "success"))
              .catch(() => {
                const textArea = document.createElement("textarea");
                textArea.value = this.scanResult;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                toast("Copied!", "success");
              });
          },

          resetPage() {
            window.location.reload();
          },
        }));
      });
    </script>
  </body>
</html>
